# Cluster TLS guide

Cluster TLS policy is configured on a per-cluster basis via the TPR spec provided to etcd-operator.
For etcd's TLS support and requirements, please read the relevant section in etcd [operations guide](https://coreos.com/etcd/docs/latest/op-guide/security.html).


## Static cluster TLS Policy

Static TLS means keys/certs are generated by user and passed to operator.

Let's use the following example and walk through the spec:

```yaml
apiVersion: "etcd.coreos.com/v1beta1"
kind: "Cluster"
metadata:
  name: example
  namespace: default
spec:
  ...
  TLS:
    static:
      member:
        peerSecret: etcd-server-peer-tls
        clientSecret: etcd-server-client-tls
```

### member.peerSecret

`member.peerSecret` contains pem-encoded private keys and x509 certificates for etcd peer communication.

The certificate should allow wildcard domain `*.${clusterName}.${namespace}.svc.cluster.local`.
In this case, it is `*.example.default.svc.cluster.local`.

The peer TLS assets should have the following:
- **peer-crt.pem**: peer communication cert.
- **peer-key.pem**: peer communication key.
- **peer-ca-crt.pem**: CA cert for this peer key-cert pair.

Create a secret containing those:
```
$ kubectl create secret generic etcd-server-peer-tls --from-file=peer-ca-crt.pem --from-file=peer-crt.pem --from-file=peer-key.pem
```

Once passed, etcd-operator will mount this secret at `/etc/etcd-operator/member/peer-tls/` for each etcd member pod in the cluster.


### member.clientSecret

`member.clientSecret` contains pem-encoded private keys and x509 certificates for etcd client communication on server side.

(TODO: How to specify SAN)

etcd-operator will mount this secret at `/etc/etcd-operator/member/client-tls/` for each etcd member pod in the cluster.

The client TLS assets are expected to conform to the following structure:

```text
/etc/etcd-operator/member/client-tls/
      client-crt.pem
      client-key.pem
      client-ca-crt.pem
```
